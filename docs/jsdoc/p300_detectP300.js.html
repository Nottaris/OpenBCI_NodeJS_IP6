<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: p300/detectP300.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: p300/detectP300.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * call python script to detect P300
 *
 */
module.exports = {
    detectP300
};

const p300 = require("./p300");
const server = require("../socket/server");
const fs = require("fs");


let PythonShell = require("python-shell");

let settings;
let init = true;
let fileNr = 1;

/**
 * call python script to detect P300
 * @param {array} volts - eeg data signal
 * @param {array} baseline - eeg data baseline
 * @param {array} timestamps - of data
 * @param {array} cmdTimestamps - of commands
 */
function detectP300(volts, baseline, timestamps, cmdTimestamps) {

    if (init) {
        //get Settings only once
        settings = p300.getSettings();
        init = false;
    }

    //get index for each timestamp
    let cmdIdx = [[], [], [], [], []];
    cmdTimestamps.forEach(function(cmd, i) {
        cmd.forEach(function(currentTime) {
            let idx = getIdxForTimestamp(timestamps, currentTime);
            if (idx > -1) {
                cmdIdx[i].push(idx);
                if(settings.debug) {
                    console.log(i + " " + settings.commands[i] + " " + idx + " " + timestamps[idx] + " " + volts[idx][0]);
                }
            } else {
                console.log("No index for timestamp was found " + currentTime);
            }
        });
    });

    if(settings.debug){
        console.log(cmdIdx);
        fs.writeFile("data/p300/"+Date.now()+"_"+fileNr+"_volts.json", JSON.stringify(volts));
        fs.writeFile("data/p300/"+Date.now()+"_"+fileNr+"_baseline.json", JSON.stringify(baseline));
        fs.writeFile("data/p300/"+Date.now()+"_"+fileNr+"_cmdIdx.json", JSON.stringify(cmdIdx));
        fileNr += 1;
    }


    const options = {mode: "text"};
    let pyshell = new PythonShell("/src/pyscripts/p300detect.py", options);
    let data = JSON.stringify({volts: volts, baseline: baseline, cmdIdx: cmdIdx});

    // sends channel data to the Python script via stdin
    pyshell.send(data).end(function (err) {
        if (err) {
            console.log("pyshell send err: " + err);
        }
    });

    // received a message sent from the Python script (a simple "print" statement)
    pyshell.stdout.on("data", function (data) {
        // Remove all new lines
        let idx = data.replace(/\r?\n|\r/g, "");
        //process python result, send cmd if detected
        if (idx !== "nop") {
            let cmd = settings.commands[idx];
            //send doCommand to player to execute
            server.doP300Cmd(cmd);
        } else {
            console.log("doCmd was: " + idx);
        }
    });

    // end the input stream and allow the process to exit
    pyshell.end(function (err) {
        if (err) {
            throw err;
        }
    });

}

/**
 * find timestamp idx in timestamp array
 *
 */
function getIdxForTimestamp(timestamps, currentTime) {
    return timestamps.findIndex((timestamp) => timestamp === currentTime);
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#blink">blink</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#closeSocketServer">closeSocketServer</a></li><li><a href="global.html#detectBlink">detectBlink</a></li><li><a href="global.html#detectMind">detectMind</a></li><li><a href="global.html#detectP300">detectP300</a></li><li><a href="global.html#digestSamples">digestSamples</a></li><li><a href="global.html#doBlinkCmd">doBlinkCmd</a></li><li><a href="global.html#doMindCmd">doMindCmd</a></li><li><a href="global.html#doP300Cmd">doP300Cmd</a></li><li><a href="global.html#enoughDataForP300">enoughDataForP300</a></li><li><a href="global.html#fixJsonFile">fixJsonFile</a></li><li><a href="global.html#getAverage">getAverage</a></li><li><a href="global.html#getBaseline">getBaseline</a></li><li><a href="global.html#getBlinks">getBlinks</a></li><li><a href="global.html#getCmdTimefromPlayer">getCmdTimefromPlayer</a></li><li><a href="global.html#getFiledata">getFiledata</a></li><li><a href="global.html#getIdxForTimestamp">getIdxForTimestamp</a></li><li><a href="global.html#getMaxValue">getMaxValue</a></li><li><a href="global.html#getMedian">getMedian</a></li><li><a href="global.html#getMinValue">getMinValue</a></li><li><a href="global.html#getNewestFile">getNewestFile</a></li><li><a href="global.html#getSettings">getSettings</a></li><li><a href="global.html#getStandardDeviation">getStandardDeviation</a></li><li><a href="global.html#getTrainingCmd">getTrainingCmd</a></li><li><a href="global.html#getVariance">getVariance</a></li><li><a href="global.html#initTraining">initTraining</a></li><li><a href="global.html#loadJSON">loadJSON</a></li><li><a href="global.html#mind">mind</a></li><li><a href="global.html#openData">openData</a></li><li><a href="global.html#p300">p300</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#percentageChange">percentageChange</a></li><li><a href="global.html#reportTrainingsData">reportTrainingsData</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#saveTrainingData">saveTrainingData</a></li><li><a href="global.html#sendCmd">sendCmd</a></li><li><a href="global.html#setNextCommand">setNextCommand</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startFlashCmd">startFlashCmd</a></li><li><a href="global.html#startSocketServer">startSocketServer</a></li><li><a href="global.html#streamData">streamData</a></li><li><a href="global.html#subscribeToP300Cmds">subscribeToP300Cmds</a></li><li><a href="global.html#subscribeToTrainingCmds">subscribeToTrainingCmds</a></li><li><a href="global.html#subtractBaseline">subtractBaseline</a></li><li><a href="global.html#subtractBaselineAllChannels">subtractBaselineAllChannels</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Aug 14 2018 16:56:15 GMT+0200 (W. Europe Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
